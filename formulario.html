<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adicionar Novo Ponto de Interesse - SustAmbiTech</title>
    <link rel="stylesheet" href="style.css">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        /* ------------------------------------- */
        /* ESTILOS INLINE MANTIDOS */
        /* ------------------------------------- */
        body {
            font-family: Arial, sans-serif;
            min-height: 100vh;
            padding: 0;
            margin: 0;
            box-sizing: border-box;
            
        }

        .main-content {
            padding: 20px; /* Adiciona padding ao main-content para espa√ßamento */
            display: flex; /* Adicionado para centralizar o form dentro do main */
            justify-content: center;
        }

        #contribuicaoForm {
            background-color: #697f3f;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 800px;
        }

        h1 {
            text-align: center;
            margin-top: 0;
            margin-bottom: 25px;
        }
        /* ------------------------------------- */
        /* ESTILOS DO MAPA E LEGENDA */
        /* ------------------------------------- */
        .mapa-legenda-container {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .mapa-container {
            flex-grow: 1;
        }

        #mapaExistente {
            height: 400px;
            width: 100%;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .mapa-container h3 {
            margin-top: 0;
            color: #007bff;
            font-size: 1em;
            margin-bottom: 5px;
        }
        
        /* Estilo da Legenda (PC) */
        .legenda {
            height: 100%;
            flex-basis: 200px;
            padding: 15px;
            background-color: #697f3f;
            border: 1px solid #ddd;
            border-radius: 4px;
            align-self: flex-start;
        }

        .legenda-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
            font-size: 0.9em;
        }

        .legenda-cor {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            border: 2px solid #333;
        }

        /* ------------------------------------- */
        /* ESTILOS GERAIS DO FORMUL√ÅRIO */
        /* ------------------------------------- */
        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }

        input:not([type="radio"]),
        textarea,
        select {
            width: 100%;
            padding: 10px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 4px;
            transition: border-color 0.3s;
        }

        input:focus,
        textarea:focus,
        select:focus {
            border-color: #4CAF50;
            outline: none;
        }

        /* Input Readonly/Disabled */
        input[readonly], select[disabled] {
            background-color: #f0f0f0;
            color: #777;
        }

        /* DIVIS√ÉO DO CAMPO TIPO/OUTROS */
        .select-with-input-group {
            display: flex;
            gap: 10px;
        }

        .select-with-input-group select {
            flex: 1;
        }

        .select-with-input-group input {
            flex: 1;
            display: none;
            margin-top: 0 !important;
        }

        /* Agrupamentos com bot√µes */
        .input-with-button-group {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .input-with-button-group .form-group {
            flex-grow: 1;
            margin-bottom: 0;
        }
        
        /* Layout de Endere√ßo em Colunas */
        .endereco-row {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 10px;
        }

        .endereco-row .form-group {
            flex: 1;
            min-width: 100px;
            margin-bottom: 0;
        }

        .endereco-row .form-group-numero {
            flex: 0 0 80px;
        }


        /* Estilos dos Bot√µes */
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
            transition: background-color 0.3s;
            white-space: nowrap;
            width: 100%; /* Bot√£o de Envio */
        }

        button:hover {
            background-color: #45a049;
        }

        #btnLocalizarDispositivo {
            background-color: #2196F3;
            height: 40px;
            padding: 0 15px;
            display: block; 
            width: 100%;
            margin-top: 0; 
            text-align: center;
        }

        #btnLocalizarDispositivo:hover {
            background-color: #0b7dda;
        }
        
        /* Mensagem de Status */
        #msgStatus {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            font-size: 0.9em;
            color: #333;
            background-color: #fff3cd; 
            border: 1px solid #ffe0a3;
            display: none;
        }

        /* BOX DE REVIS√ÉO */
        #revisaoFinalBox {
            padding: 15px;
            background-color: #587029;
            border-left: 5px solid #FF9800; /* Cor Laranja para aten√ß√£o */
            border-radius: 4px;
            margin: 30px 0;
            font-size: 0.9em;
        }

        #revisaoFinalBox h4 {
            color: #FF9800;
            margin-top: 0;
            
        }
        input, textarea, select{
            background-color: #f3f3f3;
        }
        /* ------------------------------------- */
        /* Responsividade */
        /* ------------------------------------- */
        @media (max-width: 768px) {
            #contribuicaoForm {
                padding: 15px;
                box-shadow: none;
            }

            .input-with-button-group {
                flex-direction: column;
                align-items: stretch;
                gap: 0;
            }

            .input-with-button-group .form-group {
                margin-bottom: 10px;
            }

            .input-with-button-group button {
                width: 100%;
                margin-top: 0;
            }

            /* Quebra o layout de mapa/legenda */
            .mapa-legenda-container {
                flex-direction: column;
            }

            /* A Legenda em Mobile se torna um bloco de largura total e √© empurrada para baixo (order: 1) */
            .legenda {
                flex-basis: auto;
                order: 1; /* Manda a legenda para baixo do mapa */
            }
            
            .mapa-container {
                order: 0; /* Garante que o mapa venha primeiro */
            }

            /* Endere√ßo quebra em telas pequenas */
            .endereco-row .form-group {
                flex: 1 1 100%;
            }

            /* Tipo de Ponto / Outros tamb√©m quebra em telas pequenas */
            .select-with-input-group {
                flex-direction: column;
                gap: 0;
            }

            .select-with-input-group input {
                margin-top: 10px !important;
            }
        }
    </style>
</head>

<body>
<div style="z-index: 9999; position: absolute;" id="menu-container"></div>
    <br>
    <br>
    <br>
    <br>
    <main class="main-content">
        <form id="contribuicaoForm">
            <h1>Adicionar Novo Ponto de Interesse Ambiental üó∫Ô∏è</h1>

            <div class="form-group">
                <label for="email">Email (ser√° preenchido automaticamente se logado):</label>
                <input type="email" id="email" name="email" required placeholder="seu.email@exemplo.com">
            </div>

            <hr style="border: 0; border-top: 1px solid #eee; margin: 30px 0;">

            <h2>1. Centralize o Mapa (Onde voc√™ est√° ou pr√≥ximo)</h2>
            <br>
            <p style="font-size: 0.9em; margin-top: -15px;">Clique para centralizar o mapa na sua localiza√ß√£o atual e facilitar a busca do novo ponto.</p>
            <br>

            <button type="button" id="btnLocalizarDispositivo">
                <span id="btnLocalizarDispositivoText">Usar Localiza√ß√£o do Dispositivo</span>
            </button>
            <br>
            <h3>1. Ponto Existente (Coloridos) | Ponto Novo (Pin Azul)</h3>
            <br>
            <h3>2. Clique ou Arraste o Pin Azul para o Local Correto!</h3>
            <br>
            <div id="camposAvancados" style="margin-top: 30px;">
                <div class="mapa-legenda-container">
                    <div class="mapa-container">
                        <div id="mapaExistente"></div>
                    </div>

                    <div class="legenda">
                        <h4>Legenda</h4>
                        <div id="legendaContent"></div>
                    </div>
                </div>

                <div id="msgStatus" style="display: none;"></div>

                <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">

                <h2>2. Detalhes do Novo Ponto de Interesse</h2>
                <br>
                <p style="font-size: 0.9em; margin-top: -15px;">Campos preenchidos pelo CEP podem ser ajustados. O <b>N√∫mero</b> √© obrigat√≥rio.</p>
                <br>
                <div class="form-group">
                    <label for="nomeLocal">Nome do Local (Obrigat√≥rio):</label>
                    <input type="text" id="nomeLocal" name="nomeLocal" required placeholder="Ex: Ecoponto da Pra√ßa X">
                </div>
                <label>Coordenadas (Geradas ao Clicar no Mapa):</label>
                <div class="endereco-row">
                     <div class="form-group">
                        <input style="background-color: #ccc;" type="text" id="latitude" name="latitude" placeholder="Latitude" readonly required>
                    </div>
                    <div class="form-group">
                        <input style="background-color: #ccc;" type="text" id="longitude" name="longitude" placeholder="Longitude" readonly required>
                    </div>
                </div>

                <div class="endereco-row">
                    <div class="form-group" style="flex: 2;">
                        <label for="tipoPontoSelect">Informa√ß√µes/Tipo de Ponto (Obrigat√≥rio):</label>
                        <div class="select-with-input-group">
                            <select id="tipoPontoSelect" name="tipoPontoSelect" required>
                                <option value="" disabled selected>-- Selecione o Tipo --</option>
                                <option value="Posto Eletro">Posto Eletro</option>
                                <option value="Eco Posto">Eco Posto</option>
                                <option value="Descarte de Pilha">Descarte de Pilha</option>
                                <option value="Reciclagem">Reciclagem</option>
                                <option value="√ìleo de Cozinha">Descarte de √ìleo de Cozinha</option>
                                <option value="Roupas/T√™xtil">Doa√ß√£o de Roupas/T√™xtil</option>
                                <option value="Pneu">Descarte de Pneus</option>
                                <option value="Outros">Outros [Escrever]</option>
                            </select>
                            <input type="text" id="outrosEspecificar" name="outrosEspecificar"
                                placeholder="Especifique o tipo 'Outros'">
                        </div>
                    </div>
                    
                    <!-- Campo de Avalia√ß√£o: Permanece opcional e n√£o √© enviado com a sugest√£o inicial -->
                    <div class="form-group" style="flex: 1; min-width: 120px;">
                        <label for="avaliacaoSelect">Avalia√ß√£o (0-5):</label>
                        <select id="avaliacaoSelect" name="avaliacaoSelect">
                            <option value="" disabled selected>Avaliar (Opcional)</option>
                            <option value="0">0 (P√©ssimo)</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5 (Excelente)</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="cep">CEP do Novo Ponto (Ser√° validado e preenchido automaticamente):</label>
                    <input type="text" id="cep" name="cep" placeholder="Ex: 00000-000" maxlength="9" required>
                </div>

                <label>Endere√ßo Detalhado:</label>
                <div class="endereco-row">
                    <div class="form-group">
                        <input type="text" id="rua" name="rua" placeholder="Rua / Logradouro">
                    </div>
                    <div class="form-group form-group-numero">
                        <input type="text" id="numero" name="numero" placeholder="N¬∫" required>
                    </div>
                </div>
                <div class="endereco-row">
                    <div class="form-group">
                        <input type="text" id="bairro" name="bairro" placeholder="Bairro">
                    </div>
                    <div class="form-group">
                        <input type="text" id="cidade" name="cidade" placeholder="Cidade">
                    </div>
                    <div class="form-group form-group-numero">
                        <input type="text" id="estado" name="estado" maxlength="2" placeholder="UF">
                    </div>
                </div>

                <div class="form-group">
                    <label for="observacao">Observa√ß√£o (M√°x. 500 caracteres, ex: Hor√°rio de funcionamento, etc.):</label>
                    <textarea id="observacao" name="observacao" rows="5" maxlength="500"></textarea>
                </div>
                
                <hr style="border: 0; border-top: 1px solid #eee; margin: 30px 0;">

                <div id="revisaoFinalBox">
                    <h4>‚ö†Ô∏è Revis√£o Final Necess√°ria ‚ö†Ô∏è</h4>
                    <p>O preenchimento do endere√ßo por CEP utiliza uma base de dados externa (ViaCEP), que pode estar sujeita a <b>erros ou desatualiza√ß√µes</b>. Al√©m disso, a localiza√ß√£o no mapa √© a sua estimativa (Pin Azul).</p>
                    <p>Por favor, <b>confirme manualmente</b> se o endere√ßo e o n√∫mero est√£o corretos, e se o Pin Azul no mapa est√° no local exato antes de enviar.</p>
                </div>

                <button type="submit">Enviar Novo Ponto</button>
            </div>
        </form>
        </main>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <div id="footer-container"></div>

    <script src="main.js" type="module"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            fetch('footer.html')
                .then(response => response.text())
                .then(data => {
                    document.getElementById('footer-container').innerHTML = data;
                })
                .catch(error => console.error('Erro ao carregar o rodap√©:', error));
        });
    </script>

    <script type="module">
        // Importa√ß√µes necess√°rias do Firebase e do seu main.js
        import { auth, database } from './main.js';
        import { get, ref, push, query, orderByChild, equalTo } from 'https://www.gstatic.com/firebasejs/10.9.0/firebase-database.js';
        import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.9.0/firebase-auth.js';

        let mapa = null;
        let marcadorTemporario = null;
        let marcadorLocalizacaoUsuario = null;
        let currentUser = null; // Vari√°vel para armazenar o usu√°rio logado

        const DEFAULT_LAT = -23.5505;
        const DEFAULT_LON = -46.6333;
        const DEFAULT_ZOOM = 14;

        const tipoParaCor = {
            'Posto Eletro': '#FF0000',
            'Eco Posto': '#008000',
            'Descarte de Pilha': '#800080',
            'Reciclagem': '#FFA500',
            '√ìleo de Cozinha': '#00CED1',
            'Roupas/T√™xtil': '#FF69B4',
            'Pneu': '#696969',
            'Outros': '#000000'
        };

        // --- Fun√ß√µes Auxiliares ---

        // Fun√ß√£o para criar √≠cones coloridos no mapa
        function criarIconeColorido(tipo, cor) {
            return L.divIcon({
                className: 'custom-div-icon',
                html: `<div style="background-color: ${cor}; width: 15px; height: 15px; border-radius: 50%; border: 2px solid #333;"></div>`,
                iconSize: [20, 20],
                iconAnchor: [10, 10],
                popupAnchor: [0, -10]
            });
        }

        // Fun√ß√£o para buscar endere√ßo por CEP
        async function buscarEnderecoPorCEP(cep, isNewPoint = false) {
            const cepLimpo = cep.replace(/\D/g, '');
            if (cepLimpo.length !== 8) return null;

            if (!isNewPoint) return null;

            const targetRua = document.getElementById('rua');
            const targetBairro = document.getElementById('bairro');
            const targetCidade = document.getElementById('cidade');
            const targetEstado = document.getElementById('estado');

            const msgElement = document.getElementById('msgStatus');
            msgElement.style.display = 'block';
            msgElement.style.backgroundColor = '#fff3cd';
            msgElement.innerHTML = `Buscando endere√ßo para o CEP ${cepLimpo}...`;

            document.getElementById('numero').value = '';

            try {
                const url = `https://viacep.com.br/ws/${cepLimpo}/json/`;
                const response = await fetch(url);
                const data = await response.json();

                if (data.erro) {
                    throw new Error('CEP n√£o encontrado ou inv√°lido.');
                }

                targetRua.value = data.logradouro || '';
                targetBairro.value = data.bairro || '';
                targetCidade.value = data.localidade || '';
                targetEstado.value = data.uf || '';

                msgElement.style.backgroundColor = '#e6ffe6';
                msgElement.innerHTML = `Endere√ßo encontrado e preenchido (Rua, Bairro, Cidade). <b>Por favor, preencha o N√∫mero e confira!</b>`;

                return {
                    rua: data.logradouro || '',
                    bairro: data.bairro || '',
                    cidade: data.localidade || '',
                    estado: data.uf || ''
                };

            } catch (error) {
                msgElement.style.backgroundColor = '#f8d7da';
                msgElement.innerHTML = `Erro: ${error.message}. Preencha o endere√ßo manualmente.`;
                console.error("Erro no ViaCEP:", error);
                targetRua.value = '';
                targetBairro.value = '';
                targetCidade.value = '';
                targetEstado.value = '';
                return null;
            } finally {
                setTimeout(() => { msgElement.style.display = 'none'; }, 8000);
            }
        }

        // Fun√ß√£o para reverter coordenadas para endere√ßo
        async function reverterCoordenadas(lat, lon) {
            console.log(`Buscando endere√ßo real para: ${lat}, ${lon}`);
            const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&addressdetails=1`;

            try {
                const response = await fetch(url);
                const data = await response.json();

                if (data && data.address) {
                    const addr = data.address;
                    const bairro = addr.suburb || addr.neighbourhood || addr.village || '';
                    
                    let cep = (addr.postcode || '').replace(/\D/g, '');
                    if (cep.length >= 8) { // Ajuste para o formato XX.XXX-XXX
                         cep = cep.substring(0, 5) + '-' + cep.substring(5, 8);
                    } else if (cep.length > 0) {
                         // Se tiver menos de 8, mant√©m o que tem
                    } else {
                         cep = '';
                    }

                    return {
                        cep: cep,
                        rua: addr.road || addr.footway || 'Logradouro n√£o identificado',
                        bairro: bairro,
                        cidade: addr.city || addr.town || addr.village || '',
                        estado: addr.state_code || addr.state || ''
                    };
                } else {
                    throw new Error('Coordenadas n√£o puderam ser revertidas para endere√ßo.');
                }
            } catch (error) {
                 console.error("Erro na Geocodifica√ß√£o Reversa:", error);
                 throw new Error("Erro na busca de endere√ßo pelo mapa.");
            }
        }

        // FUN√á√ÉO ATUALIZADA: Adicionar Marcador de Novo Ponto (com preenchimento de endere√ßo)
        async function adicionarMarcadorNovoPonto(e) {
            const latlng = e.latlng || e.target.getLatLng();
            const lat = latlng.lat.toFixed(6);
            const lon = latlng.lng.toFixed(6);

            const msgElement = document.getElementById('msgStatus');

            if (marcadorTemporario) {
                mapa.removeLayer(marcadorTemporario);
            }

            marcadorTemporario = L.marker(latlng, { draggable: true }).addTo(mapa)
                .bindPopup("Novo Ponto de Interesse: Arraste para ajuste fino.").openPopup();

            document.getElementById('latitude').value = lat;
            document.getElementById('longitude').value = lon;

            msgElement.style.display = 'block';
            msgElement.style.backgroundColor = '#e6ffe6';
            msgElement.innerHTML = `<b>Local Selecionado!</b> Coordenadas: ${lat}, ${lon}. Buscando endere√ßo aproximado...`;

            try {
                const endereco = await reverterCoordenadas(latlng.lat, latlng.lng);

                document.getElementById('cep').value = endereco.cep || document.getElementById('cep').value;
                document.getElementById('rua').value = endereco.rua;
                document.getElementById('bairro').value = endereco.bairro;
                document.getElementById('cidade').value = endereco.cidade;
                document.getElementById('estado').value = endereco.estado;

                document.getElementById('numero').value = '';

                msgElement.innerHTML = `<b>Local Selecionado!</b> Endere√ßo aproximado preenchido pelo mapa. Por favor, <b>preencha o N√∫mero e confira o CEP</b>.`;
                msgElement.style.backgroundColor = '#d4edda';

            } catch (error) {
                 msgElement.innerHTML = `<b>Local Selecionado, mas o endere√ßo n√£o p√¥de ser encontrado.</b> Por favor, preencha todos os campos manualmente.`;
                 msgElement.style.backgroundColor = '#f8d7da';
                 console.error("Erro ao preencher endere√ßo ap√≥s clique:", error);
            } finally {
                if (marcadorTemporario) {
                    marcadorTemporario.on('dragend', adicionarMarcadorNovoPonto);
                }
                setTimeout(() => { msgElement.style.display = 'none'; }, 8000);
            }
        }

        // Fun√ß√£o para centralizar o mapa
        function centralizarMapa(lat, lon, zoom = DEFAULT_ZOOM) {
            mapa.setView([lat, lon], zoom);
            mapa.invalidateSize();
        }

        // Fun√ß√£o para atualizar marcador do usu√°rio
        function atualizarMarcadorUsuario(lat, lon, info) {
            const userLatLng = [lat, lon];
            const iconeUsuario = L.marker(userLatLng, {
                icon: L.divIcon({
                    className: 'custom-user-icon',
                    html: `<div style="font-size: 1.5em; color: #ff0000;">üìç</div>`,
                    iconSize: [25, 25],
                    iconAnchor: [12, 25]
                })
            });

            if (marcadorLocalizacaoUsuario) {
                mapa.removeLayer(marcadorLocalizacaoUsuario);
            }

            marcadorLocalizacaoUsuario = iconeUsuario.addTo(mapa)
                .bindPopup(`<b>Sua Refer√™ncia:</b><br>${info}`).openPopup();
        }

        // FUN√á√ÉO ATUALIZADA: Inicializar Mapa (para carregar pontos ATIVOS do Firebase)
                // FUN√á√ÉO ATUALIZADA: Inicializar Mapa (para carregar pontos ATIVOS do Firebase)
        async function inicializarMapa(lat, lon) {
            const center = [lat || DEFAULT_LAT, lon || DEFAULT_LON];

            if (mapa) {
                mapa.remove();
            }

            mapa = L.map('mapaExistente').setView(center, DEFAULT_ZOOM);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(mapa);

            // --- Carregar pontos ATIVOS do Firebase Realtime Database ---
            try {
                const pontosAtivosQuery = query(ref(database, 'pontos'), orderByChild('ativo'), equalTo(true));
                const snapshot = await get(pontosAtivosQuery);

                // --- NOVO: console.log para verificar os dados ---
                if (snapshot.exists()) {
                    const pontosData = snapshot.val();
                    console.log("Dados de pontos ativos carregados do Firebase:", pontosData); // <--- Adicionado
                    Object.keys(pontosData).forEach(key => {
                        const ponto = pontosData[key];
                        const cor = tipoParaCor[ponto.tipoPonto] || '#000000';
                        const icone = criarIconeColorido(ponto.tipoPonto, cor);

                        if (typeof ponto.latitude === 'number' && typeof ponto.longitude === 'number') {
                            L.marker([ponto.latitude, ponto.longitude], { icon: icone })
                                .addTo(mapa)
                                .bindPopup(`
                                    <b>${ponto.nome}</b><br>
                                    Tipo: ${ponto.tipoPonto}<br>
                                    Endere√ßo: ${ponto.rua || 'N/A'}, ${ponto.numero || 'S/N'}<br>
                                    Bairro: ${ponto.bairro || 'N/A'}<br>
                                    Cidade: ${ponto.cidade || 'N/A'} - ${ponto.estado || 'N/A'}<br>
                                    CEP: ${ponto.cep || 'N/A'}
                                `);

                        } else {
                            console.warn(`Ponto "${ponto.nome}" (ID: ${key}) possui coordenadas inv√°lidas e n√£o ser√° exibido no mapa.`);
                        }
                    });
                } else {
                    console.log("Nenhum ecoponto ativo encontrado no Firebase (consulta retornou vazio)."); // <--- Adicionado
                }
            } catch (error) {
                console.error("Erro ao carregar ecopontos do Firebase:", error);
            }
            // --- Fim do carregamento de ecopontos ---

            mapa.on('click', adicionarMarcadorNovoPonto);

            mapa.invalidateSize();
            // --- NOVO: Chamada adicional de invalidateSize ap√≥s o carregamento dos dados ---
            // Isso pode ajudar se a tabela (ou outros elementos) estiverem afetando o layout do mapa.
            setTimeout(() => {
                mapa.invalidateSize();
            }, 100); // Pequeno atraso para garantir que o DOM esteja renderizado


            preencherLegenda();
        }


        // Fun√ß√£o para preencher a legenda do mapa
        function preencherLegenda() {
            const legendaDiv = document.getElementById('legendaContent');
            let html = '<h4>Legenda de Pontos</h4>';

            for (const tipo in tipoParaCor) {
                const cor = tipoParaCor[tipo];
                html += `
                    <div class="legenda-item">
                        <div class="legenda-cor" style="background-color: ${cor};"></div>
                        <span>${tipo}</span>
                    </div>
                `;
            }

            html += `
                <hr style="border: 0; border-top: 1px solid #ddd; margin: 10px 0;">
                <h4>Sua Contribui√ß√£o</h4>
                <div class="legenda-item">
                    <img src="https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png"
                        alt="Pin Azul" style="width: 15px; margin-right: 8px;">
                    <span>Novo Ponto (Sua Escolha)</span>
                </div>
                <div class="legenda-item">
                    <div style="font-size: 1.2em; margin-right: 8px; color: #ff0000;">üìç</div>
                    <span>Refer√™ncia (Centraliza√ß√£o)</span>
                </div>
            `;
            legendaDiv.innerHTML = html;
        }

        // Fun√ß√£o para mostrar/esconder campo "Outros"
        function mostrarCampoOutros(isOutros) {
            const campoOutros = document.getElementById('outrosEspecificar');
            const select = document.getElementById('tipoPontoSelect');

            campoOutros.style.display = isOutros ? 'block' : 'none';
            select.style.flex = isOutros ? '1' : '2';

            if (!isOutros) {
                campoOutros.value = '';
            }
        }

        // Fun√ß√£o para localizar pelo dispositivo
        function localizarPeloDispositivo() {
            const btnText = document.getElementById('btnLocalizarDispositivoText');
            const originalText = 'Usar Localiza√ß√£o do Dispositivo';
            const msgElement = document.getElementById('msgStatus');

            btnText.textContent = 'Aguarde...';
            msgElement.style.display = 'block';
            msgElement.style.backgroundColor = '#fff3cd';
            msgElement.innerHTML = `Aguardando permiss√£o de localiza√ß√£o do dispositivo...`;

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;

                        centralizarMapa(lat, lon, 16);
                        atualizarMarcadorUsuario(lat, lon, `Sua Localiza√ß√£o Aproximada (Lat/Lon: ${lat.toFixed(4)}, ${lon.toFixed(4)})`);

                        btnText.textContent = 'Mapa Centralizado!';
                        msgElement.innerHTML = `Mapa centralizado na sua localiza√ß√£o.`;
                        msgElement.style.backgroundColor = '#d4edda';

                        setTimeout(() => { btnText.textContent = originalText; }, 3000);
                        setTimeout(() => { msgElement.style.display = 'none'; }, 5000);
                    },
                    (error) => {
                        console.error("Erro de Geolocaliza√ß√£o:", error);
                        btnText.textContent = 'Erro!';
                        msgElement.innerHTML = `Erro: ${error.message}. Permiss√£o negada ou localiza√ß√£o indispon√≠vel.`;
                        msgElement.style.backgroundColor = '#f8d7da';

                        setTimeout(() => { btnText.textContent = originalText; }, 3000);
                        setTimeout(() => { msgElement.style.display = 'none'; }, 8000);
                    }
                );
            } else {
                btnText.textContent = 'Indispon√≠vel';
                msgElement.innerHTML = `Seu navegador n√£o suporta geolocaliza√ß√£o.`;
                msgElement.style.backgroundColor = '#f8d7da';
                setTimeout(() => { msgElement.style.display = 'none'; }, 8000);
            }
        }

        // FUN√á√ÉO ATUALIZADA: Enviar Formul√°rio para o n√≥ 'pontos'
        async function enviarFormularioPonto(event) {
            event.preventDefault();

            if (!currentUser) {
                alert('Voc√™ precisa estar logado para enviar uma sugest√£o de ponto.');
                window.location.href = 'login.html'; // Redireciona para a p√°gina de login
                return;
            }

            const emailForm = document.getElementById('email').value;
            const lat = document.getElementById('latitude').value;
            const lon = document.getElementById('longitude').value;
            const tipoPontoSelecionado = document.getElementById('tipoPontoSelect').value;
            const nomeLocal = document.getElementById('nomeLocal').value;
            const numero = document.getElementById('numero').value;
            const cep = document.getElementById('cep').value.replace(/\D/g, '');
            const rua = document.getElementById('rua').value;
            const bairro = document.getElementById('bairro').value;
            const cidade = document.getElementById('cidade').value;
            const estado = document.getElementById('estado').value;
            const observacao = document.getElementById('observacao').value;

            // Valida√ß√µes adicionais para campos requeridos no HTML e no BD
            if (!emailForm || !nomeLocal || !tipoPontoSelecionado || !numero || !cep || !lat || !lon) {
                alert('Por favor, preencha todos os campos obrigat√≥rios (Email, Nome, Tipo, N√∫mero, CEP, Latitude e Longitude)!');
                return;
            }

            if (tipoPontoSelecionado === 'Outros' && !document.getElementById('outrosEspecificar').value.trim()) {
                alert("Por favor, especifique o tipo 'Outros'.");
                return;
            }

            const tipoFinal = tipoPontoSelecionado === 'Outros' ? document.getElementById('outrosEspecificar').value.trim() : tipoPontoSelecionado;

            // Monta o objeto de dados para o Realtime Database, com 'ativo: false' por padr√£o
            const suggestionData = {
                ativo: false, // √â uma sugest√£o, portanto inativo por padr√£o
                usuarioId: currentUser.uid,
                email: currentUser.email || emailForm,
                nome: nomeLocal, // Renomeado de nomeLocal para nome para corresponder √† nova estrutura
                tipoPonto: tipoFinal,
                numero: numero,
                cep: cep,
                latitude: parseFloat(lat),
                longitude: parseFloat(lon),
                rua: rua || null,
                bairro: bairro || null,
                cidade: cidade || null,
                estado: estado || null,
                observacoes: observacao || null, // Observa√ß√µes tamb√©m podem ser nulas
                data: new Date().toISOString()
            };

            console.log('--- Dados de Sugest√£o Enviados para "pontos" ---');
            console.log(suggestionData);
            console.log('------------------------------------');

            try {
                await push(ref(database, 'pontos'), suggestionData); // Salvando no n√≥ 'pontos'
                alert('Sua sugest√£o de Ponto de Interesse foi enviada com sucesso para modera√ß√£o! Obrigado! üå±');

                // Limpa o formul√°rio e reseta o mapa ap√≥s o sucesso
                document.getElementById('contribuicaoForm').reset();
                if (marcadorTemporario) {
                    mapa.removeLayer(marcadorTemporario);
                    marcadorTemporario = null;
                }
                if (marcadorLocalizacaoUsuario) {
                     mapa.removeLayer(marcadorLocalizacaoUsuario);
                     marcadorLocalizacaoUsuario = null;
                }
                document.getElementById('msgStatus').style.display = 'none';
                inicializarMapa(DEFAULT_LAT, DEFAULT_LON);

            } catch (error) {
                console.error("Erro ao salvar sugest√£o no Firebase:", error);
                alert('Erro ao enviar a sugest√£o. Por favor, tente novamente. Detalhes no console.');
            }
        }

        // L√≥gica Principal: DOMContentLoaded
        document.addEventListener('DOMContentLoaded', () => {
            // L√≥gica para preencher o e-mail automaticamente (espec√≠fico para esta p√°gina)
            onAuthStateChanged(auth, (user) => {
                currentUser = user; // Armazena o usu√°rio logado
                const emailInput = document.getElementById('email');
                if (user && user.email) {
                    emailInput.value = user.email;
                    emailInput.readOnly = true; // Torna o campo somente leitura
                    emailInput.style.backgroundColor = '#e0e0e0'; // Indica que √© somente leitura
                } else {
                    emailInput.value = '';
                    emailInput.readOnly = false;
                    emailInput.style.backgroundColor = '';
                }
            });

            // Inicializa o mapa com a posi√ß√£o padr√£o
            inicializarMapa(DEFAULT_LAT, DEFAULT_LON);

            // Inicializa a visibilidade do campo 'outrosEspecificar' com base no valor inicial do select
            const tipoPontoSelect = document.getElementById('tipoPontoSelect');
            if (tipoPontoSelect) {
                tipoPontoSelect.addEventListener('change', (e) => mostrarCampoOutros(e.target.value === 'Outros'));
                // Chama uma vez no carregamento para o estado inicial
                mostrarCampoOutros(tipoPontoSelect.value === 'Outros');
            }

            // Adiciona event listeners aos bot√µes e formul√°rios
            const contribuicaoForm = document.getElementById('contribuicaoForm');
            if (contribuicaoForm) {
                contribuicaoForm.addEventListener('submit', enviarFormularioPonto);
            }

            const btnLocalizarDispositivo = document.getElementById('btnLocalizarDispositivo');
            if (btnLocalizarDispositivo) {
                btnLocalizarDispositivo.addEventListener('click', localizarPeloDispositivo);
            }
            
            // Event listener para o campo CEP
            const cepInput = document.getElementById('cep');
            if (cepInput) {
                cepInput.addEventListener('blur', (e) => buscarEnderecoPorCEP(e.target.value, true));
            }
        });
    </script>
</body>
</html>
