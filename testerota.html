<!DOCTYPE html>
<html>
<head>
    <title>Mapa de Rotas - Partida na Localiza√ß√£o Atual ou Endere√ßo</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/SVRMgki+jGD/Sevdg="
        crossorigin=""/>

    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />

    <style>
        /* ESTILO CRUCIAL: O mapa precisa de uma altura */
        #map {
            height: 500px; 
            width: 100%; 
            z-index: 1; 
        }
        
        /* Estilos do Painel de Controle */
        #control-panel {
            padding: 15px;
            background-color: #f8f8f8;
            border-bottom: 1px solid #ccc;
            margin-bottom: 10px;
        }
        
        .origin-group {
            display: flex;
            gap: 10px;
        }

        input[type="text"], button {
            padding: 10px;
            margin: 5px 0;
            box-sizing: border-box;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        #origin-input {
            flex-grow: 1; 
        }

        .origin-group button {
            width: 180px; /* Largura ajustada para o texto */
            min-width: 180px;
            margin: 5px 0;
            background-color: #3b5998;
            color: white;
            cursor: pointer;
        }
        
        #control-panel > button {
            width: 100%;
            background-color: #0078A8;
            color: white;
            cursor: pointer;
            font-weight: bold;
        }
        
        #control-panel > button:hover {
            opacity: 0.9;
        }

        .error {
            color: red;
            font-weight: bold;
            margin-top: 5px;
        }
    </style>
</head>
<body onload="initMap()">

    <div id="control-panel">
        <label for="origin-input">Ponto de Partida:</label>
        
        <div class="origin-group">
            <input id="origin-input" type="text" placeholder="Digite o endere√ßo de partida, ou use o bot√£o ao lado" value="">
            
            <button onclick="startRouteAtLocation()">&#x1F4CD; Usar Minha Localiza√ß√£o</button>
        </div>
        
        <label for="destination-input">Ponto de Destino:</label>
        <input id="destination-input" type="text" placeholder="Digite o endere√ßo de destino (Ex: Avenida Paulista, S√£o Paulo)">

        <button onclick="calculateRoute()">Calcular Rota</button>
        
        <p id="error-message" class="error"></p>
    </div>
    
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-2P3z0UfXq1T7y6z7B0p7x6U8rBf9tD/SVRMgki+jGD/Sevdg="
        crossorigin=""></script>
    
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>

    <script>
        // Coordenadas padr√£o: S√£o Paulo
        const DEFAULT_COORDS = [-23.5505, -46.6333]; 
        const DEFAULT_ZOOM = 12;
        let map;
        let routingControl = null;
        let userLocation = null;
        let userMarker = null; 

        /**
         * Inicializa o mapa com Leaflet (centralizado em S√£o Paulo).
         */
        function initMap() {
            if (typeof L === 'undefined') {
                document.getElementById("error-message").textContent = "Erro: Biblioteca Leaflet n√£o carregada.";
                return;
            }

            // Inicializa o mapa com a centraliza√ß√£o em S√£o Paulo
            map = L.map('map').setView(DEFAULT_COORDS, DEFAULT_ZOOM);

            // Adiciona a camada de mapa (Tiles padr√£o do OpenStreetMap)
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors | Roteamento: OSRM'
            }).addTo(map);
        }

        /**
         * Tenta obter a localiza√ß√£o do usu√°rio (chamado pelo bot√£o).
         */
        function startRouteAtLocation() {
            const originInput = document.getElementById("origin-input");
            const errorMessage = document.getElementById("error-message");
            errorMessage.textContent = "";

            originInput.value = "Aguardando Localiza√ß√£o...";
            originInput.readOnly = true; 
            userLocation = null; // Limpa o estado anterior

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        // Sucesso: armazena coordenadas
                        userLocation = [position.coords.latitude, position.coords.longitude];
                        map.setView(userLocation, 14); 
                        
                        originInput.value = "Minha Localiza√ß√£o Atual (GPS)";
                        originInput.readOnly = true; 
                        
                        // √çcone para o marcador do usu√°rio
                        const markerIcon = L.icon({
                            iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
                            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                            iconSize: [25, 41],
                            iconAnchor: [12, 41],
                            popupAnchor: [1, -34],
                            shadowSize: [41, 41]
                        });

                        if (userMarker) {
                            userMarker.setLatLng(userLocation);
                        } else {
                            userMarker = L.marker(userLocation, { icon: markerIcon }).addTo(map)
                            .bindPopup("Sua Localiza√ß√£o").openPopup();
                        }
                    },
                    (error) => {
                        // Erro: volta ao estado inicial (edi√ß√£o manual)
                        errorMessage.textContent = "üìç Erro ao obter localiza√ß√£o. Digite o endere√ßo de partida.";
                        originInput.value = "";
                        originInput.readOnly = false; 
                        userLocation = null;
                        if(userMarker) map.removeLayer(userMarker);
                    },
                    { enableHighAccuracy: true, timeout: 7000, maximumAge: 0 } 
                );
            } else {
                errorMessage.textContent = "‚ö†Ô∏è Seu navegador n√£o suporta Geolocation. Por favor, digite o ponto de partida.";
                originInput.value = "";
                originInput.readOnly = false; 
            }
        }

        /**
         * Calcula e exibe a rota.
         */
        function calculateRoute() {
            const originInput = document.getElementById("origin-input").value;
            const destinationInput = document.getElementById("destination-input").value;
            const errorMessage = document.getElementById("error-message");
            errorMessage.textContent = "";

            if (!originInput || !destinationInput) {
                errorMessage.textContent = "Por favor, preencha o Ponto de Partida e o Ponto de Destino.";
                return;
            }

            // 1. Limpa o controle de rota anterior
            if (routingControl) {
                map.removeControl(routingControl);
            }
            
            let originWaypoint;
            
            // 2. Define a origem: se for o texto "Minha Localiza√ß√£o Atual (GPS)", usa as coordenadas armazenadas.
            if (userLocation && originInput === "Minha Localiza√ß√£o Atual (GPS)") {
                originWaypoint = L.latLng(userLocation[0], userLocation[1]);
            } else {
                // Caso contr√°rio, usa o texto digitado (para geocodifica√ß√£o)
                originWaypoint = originInput;
            }

            // 3. Cria e adiciona o controle de roteamento
            routingControl = L.Routing.control({
                waypoints: [
                    originWaypoint,
                    destinationInput 
                ],
                routeWhileDragging: true,
                router: L.Routing.osrmv1(), // Usa o servi√ßo OSRM
                lineOptions: {
                    styles: [{ color: '#242424', weight: 8, opacity: 0.8 }, { color: '#00ccff', weight: 4, opacity: 1 }]
                },
                language: 'pt',
                show: true, 
            }).addTo(map);

            // 4. Adiciona um listener para erros de roteamento
            routingControl.on('routingerror', function(e) {
                errorMessage.textContent = "‚ùå Erro ao calcular rota: Verifique se os endere√ßos s√£o v√°lidos.";
                console.error("Erro no roteamento:", e.error);
            });

            routingControl.on('routesfound', function(e) {
                errorMessage.textContent = "‚úÖ Rota calculada com sucesso. Dist√¢ncia: " + e.routes[0].summary.totalDistance + ", Dura√ß√£o: " + e.routes[0].summary.totalTime;
            });
        }
        
    </script>

</body>
</html>