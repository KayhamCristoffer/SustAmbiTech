<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mapa OSRM - Visualizador</title>
  <style>
    :root{
      --bg:#0f1720;
      --card:#0b1220;
      --accent:#22c55e;
      --muted:#9aa6b2;
      --glass: rgba(255,255,255,0.03);
    }
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;}
    body{background:linear-gradient(180deg,#071021 0%, #071827 100%);color:#e6eef6;display:flex;flex-direction:column;gap:12px;padding:18px;}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;}
    h1{font-size:18px;margin:0;}
    .container{display:flex;flex:1;gap:16px;min-height:0;}
    .panel{width:360px;max-width:40%;background:var(--card);padding:14px;border-radius:12px;box-shadow:0 6px 24px rgba(2,6,23,0.6);overflow:auto;}
    .mapwrap{flex:1;background:var(--glass);border-radius:12px;padding:8px;display:flex;flex-direction:column;min-height:0;}
    label{display:block;font-size:13px;color:var(--muted);margin-top:10px;}
    input[type="text"], input[type="number"], select{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit;box-sizing:border-box;}
    button{margin-top:10px;padding:10px 12px;border-radius:10px;border:0;background:var(--accent);color:#042014;font-weight:600;cursor:pointer;}
    small{color:var(--muted);}
    .iframe-container{flex:1;border-radius:10px;overflow:hidden;border:1px solid rgba(255,255,255,0.04);background:white;}
    iframe{width:100%;height:100%;border:0;min-height:480px;display:block;}
    .row{display:flex;gap:8px;}
    .row > *{flex:1;}
    .controls{display:flex;align-items:center;gap:8px;margin-top:8px;}
    .status{font-size:13px;color:var(--muted);margin-top:8px;}
    footer{font-size:13px;color:var(--muted);text-align:center;}
    @media(max-width:900px){
      .container{flex-direction:column;}
      .panel{width:100%;max-width:100%;}
    }
  </style>
</head>
<body>

  <header>
    <h1>Visualizador Map — OSRM (project-osrm.org)</h1>
    <div style="text-align:right">
      <small>Cole o HTML e abra no navegador — sem API key.</small>
    </div>
  </header>

  <div class="container">
    <aside class="panel" aria-label="Controles do mapa">
      <label for="center">Centro (lat,lon)</label>
      <input id="center" type="text" value="-23.505441,-46.565552" placeholder="-23.505441,-46.565552" />

      <label for="locs">Marcadores / locais (cada linha: lat,lon)</label>
      <textarea id="locs" rows="5" style="width:100%;padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:inherit;box-sizing:border-box;">-23.550732,-46.562805
-23.629335,-46.463585</textarea>

      <label for="zoom">Zoom (número, ex: 10)</label>
      <input id="zoom" type="number" value="10" min="1" max="20" />

      <div class="row" style="margin-top:8px;">
        <button id="updateBtn">Atualizar mapa</button>
        <button id="openBtn" style="background:#1e90ff;color:white">Abrir em nova aba</button>
      </div>

      <label style="margin-top:12px">Atualização automática</label>
      <div class="row">
        <input id="autoReload" type="number" min="0" value="0" />
        <small style="align-self:center">segundos (0 = desligado)</small>
      </div>

      <div class="controls">
        <button id="startAuto" style="background:#ef9a9a">Iniciar/Aplicar</button>
        <button id="stopAuto" style="background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)">Parar</button>
      </div>

      <div class="status" id="status">
        <div>URL atual: <span id="currentUrl" style="word-break:break-all"></span></div>
        <div id="iframeMsg" style="margin-top:6px;color:var(--muted)"></div>
      </div>

      <hr style="margin-top:12px;border:none;border-top:1px solid rgba(255,255,255,0.04)" />
      <small>
        Dica: o formato do URL usado é o mesmo do project-osrm: <br>
        <code>https://map.project-osrm.org/?z=ZOOM&center=LAT%2CLON&loc=LAT1%2CLON1&loc=LAT2%2CLON2&hl=en&alt=0&srv=0</code>
      </small>
    </aside>

    <main class="mapwrap">
      <div class="iframe-container" id="iframeContainer" style="flex:1;min-height:480px;">
        <iframe id="osrmFrame" src="" title="map.project-osrm.org"></iframe>
      </div>
      <div style="margin-top:8px">
        <small style="color:var(--muted)">Se o mapa não carregar dentro do iframe pode ser bloqueio do site (X-Frame-Options). Use "Abrir em nova aba" para visualizar direto no site.</small>
      </div>
    </main>
  </div>

  <footer>
    <small>Feito para você — atualiza o mapa junto com a página.</small>
  </footer>

<script>
(function(){
  const frame = document.getElementById('osrmFrame');
  const centerEl = document.getElementById('center');
  const locsEl = document.getElementById('locs');
  const zoomEl = document.getElementById('zoom');
  const updateBtn = document.getElementById('updateBtn');
  const openBtn = document.getElementById('openBtn');
  const currentUrlEl = document.getElementById('currentUrl');
  const autoReloadEl = document.getElementById('autoReload');
  const startAuto = document.getElementById('startAuto');
  const stopAuto = document.getElementById('stopAuto');
  const iframeMsg = document.getElementById('iframeMsg');

  // Construir URL do project-osrm com base nos inputs
  function buildOsrmUrl(){
    const base = 'https://map.project-osrm.org/';
    const centerRaw = centerEl.value.trim();
    const zoom = parseInt(zoomEl.value) || 10;

    // Normalize center: "lat,lon" -> "lat%2Clon"
    let centerParam = '';
    if(centerRaw){
      const c = centerRaw.replace(/\s+/g,'');
      centerParam = '&center=' + encodeURIComponent(c);
    }

    // locs: cada linha "lat,lon"
    const locLines = locsEl.value.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
    const locParams = locLines.map(l => '&loc=' + encodeURIComponent(l)).join('');

    // ensure z param
    const zParam = '?z=' + encodeURIComponent(zoom);

    // final URL with other defaults from example
    const url = base + zParam + centerParam + locParams + '&hl=en&alt=0&srv=0';
    return url;
  }

  function updateIframe(doForceReload=false){
    const url = buildOsrmUrl();
    currentUrlEl.textContent = url;
    try {
      // attach timestamp to force reload if needed
      const finalUrl = doForceReload ? url + (url.includes('?') ? '&_t=' + Date.now() : '?_t=' + Date.now()) : url;
      // set src only if changed to avoid unnecessary reload blink
      if(frame.src !== finalUrl){
        frame.src = finalUrl;
      }
      iframeMsg.textContent = '';
    } catch(err) {
      iframeMsg.textContent = 'Erro definindo iframe src: ' + err.message;
    }
  }

  // Initial load using default values
  updateIframe(true);

  // Update on button click
  updateBtn.addEventListener('click', function(){
    updateIframe(true);
  });

  // Open in new tab (use current built URL)
  openBtn.addEventListener('click', function(){
    const url = buildOsrmUrl();
    window.open(url, '_blank', 'noopener');
  });

  // Auto reload logic
  let intervalId = null;
  function startAutoReload(){
    stopAutoReload(); // clear existing
    const sec = Math.max(0, parseInt(autoReloadEl.value) || 0);
    if(sec <= 0){ iframeMsg.textContent = 'Atualização automática desligada (0 segundos).'; return; }
    updateIframe(true);
    intervalId = setInterval(() => {
      // reload iframe by forcing a timestamp param
      updateIframe(true);
    }, sec * 1000);
    iframeMsg.textContent = 'Atualização automática: a cada ' + sec + 's.';
  }
  function stopAutoReload(){
    if(intervalId){ clearInterval(intervalId); intervalId = null; }
    iframeMsg.textContent = 'Atualização automática parada.';
  }

  startAuto.addEventListener('click', startAutoReload);
  stopAuto.addEventListener('click', stopAutoReload);

  // Also update iframe when user presses Enter inside inputs for convenience
  [centerEl, locsEl, zoomEl].forEach(el=>{
    el.addEventListener('keydown', function(e){
      if(e.key === 'Enter' && !e.shiftKey){
        e.preventDefault();
        updateIframe(true);
      }
    });
  });

  // If the iframe refuses to load due to X-Frame-Options, show helpful message
  frame.addEventListener('load', function(){
    // try to detect blocked iframe: browsers won't let us inspect cross-origin content,
    // but we can check if the iframe has a non-empty contentDocument title (only works if same-origin).
    // We'll instead set a generic success message; if contentWindow is null, maybe blocked.
    try {
      if(frame.contentWindow){
        iframeMsg.textContent = '';
      }
    } catch(e){
      // ignore cross-origin access error
    }
  });

  // Optional: update map automatically when page becomes visible again (useful if user switched tabs)
  document.addEventListener('visibilitychange', function(){
    if(document.visibilityState === 'visible'){
      // force update to make sure map reflects page's current inputs
      updateIframe(true);
    }
  });

  // expose for console debugging
  window.osrmViewer = {
    buildOsrmUrl, updateIframe, startAutoReload, stopAutoReload
  };
})();
</script>

</body>
</html>
